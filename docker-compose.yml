version: '3.9'

services:
  evolution_api:
    image: atallux/evolution-api:v2.1.2 # Production Stable Version
    container_name: evolution_api
    restart: unless-stopped
    volumes:
      - ./evolution_store:/evolution/store # Persistent storage (images, media)
    environment:
      - SERVER_URL=${SERVER_URL}
      - AUTHENTICATION_API_KEY=${AUTHENTICATION_API_KEY}
      - DATABASE_ENABLED=true
      - DATABASE_CONNECTION_URI=postgresql://${DB_user}:${DB_password}@${DB_host}:${DB_port}/${DB_database}
      - DATABASE_CLIENT_NAME=evolution_v2
      - CACHE_REDIS_ENABLED=${CACHE_REDIS_ENABLED}
      - CACHE_REDIS_URI=${CACHE_REDIS_URI}
      - CACHE_REDIS_PREFIX=${CACHE_REDIS_PREFIX}
      - DEL_INSTANCE_ON_LOGOUT=${DEL_INSTANCE_ON_LOGOUT}
      - QB_LIMIT=${qrcode_limit}
    networks:
      - default
      - proxy # CHANGE THIS if your Traefik network has a different name
    depends_on:
      - evolution_postgres
      - evolution_redis
    labels:
      - "traefik.enable=true"
      # IMPORTANT: If using multiple subdomains, you can expand this rule: Host(`domain1.com`) || Host(`domain2.com`)
      - "traefik.http.routers.evolution.rule=Host(`${SERVER_URL}`.replace('https://', '').replace('http://', ''))" 
      - "traefik.http.routers.evolution.entrypoints=websecure"
      - "traefik.http.routers.evolution.tls.certresolver=myresolver" # Change 'myresolver' to your resolver name (e.g. 'le')
      - "traefik.http.services.evolution.loadbalancer.server.port=8080"

  evolution_postgres:
    image: postgres:15-alpine
    container_name: evolution_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_user}
      POSTGRES_PASSWORD: ${DB_password}
      POSTGRES_DB: ${DB_database}
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - default

  evolution_redis:
    image: redis:7-alpine
    container_name: evolution_redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ./redis_data:/data
    networks:
      - default

networks:
  proxy:
    external: true # Assumes 'proxy' network exists (created by Traefik)
