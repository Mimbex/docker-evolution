
services:
  evolution_api:
    image: atendai/evolution-api:v2.1.1 # Production Stable Version
    container_name: evolution_api
    restart: unless-stopped
    volumes:
      - evolution_store:/evolution/store
    environment:
      - SERVER_URL=${SERVER_URL}
      - AUTHENTICATION_API_KEY=${AUTHENTICATION_API_KEY}
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://${DB_user}:${DB_password}@${DB_host}:${DB_port}/${DB_database}
      - DATABASE_CLIENT_NAME=evolution_v2
      - CACHE_REDIS_ENABLED=${CACHE_REDIS_ENABLED}
      - CACHE_REDIS_URI=${CACHE_REDIS_URI}
      - CACHE_REDIS_PREFIX=${CACHE_REDIS_PREFIX}
      - DEL_INSTANCE_ON_LOGOUT=${DEL_INSTANCE_ON_LOGOUT}
      - QB_LIMIT=${qrcode_limit}
    networks:
      - default
      - proxy
    depends_on:
      - evolution_postgres
      - evolution_redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.evolution.rule=Host(`${SERVER_URL}`.replace('https://', '').replace('http://', ''))" 
      - "traefik.http.routers.evolution.entrypoints=websecure"
      - "traefik.http.routers.evolution.tls.certresolver=myresolver"
      - "traefik.http.services.evolution.loadbalancer.server.port=8080"

  evolution_postgres:
    image: postgres:15-alpine
    container_name: evolution_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_user}
      POSTGRES_PASSWORD: ${DB_password}
      POSTGRES_DB: ${DB_database}
    volumes:
      - evolution_postgres_data:/var/lib/postgresql/data
    networks:
      - default

  evolution_redis:
    image: redis:7-alpine
    container_name: evolution_redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - evolution_redis_data:/data
    networks:
      - default

volumes:
  evolution_store:
  evolution_postgres_data:
  evolution_redis_data:

networks:
  proxy:
    external: true
